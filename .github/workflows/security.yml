name: Security

on:
  push:
    branches:
      - 'rc/**'
      - 'release/**'
  pull_request:
    branches:
      - '**'
  schedule:
    - cron: '0 6 * * 1'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  # 1. PR Check: Runs pnpm audit to catch new vulnerabilities
  pnpm-audit:
    if: ${{ github.event_name == 'pull_request' || github.event_name == 'push' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' }}
    runs-on: blacksmith-2vcpu-ubuntu-2204
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup
        uses: ./.github/actions/setup

      - name: Security Guard (Banned Lockfile Versions)
        run: pnpm security:guard

      # Non-blocking: report all production vulnerabilities for visibility.
      # This is informational only and should not fail CI.
      - name: pnpm audit (prod) report (non-blocking)
        continue-on-error: true
        run: pnpm audit --prod

      # Blocking: fail only on HIGH/CRITICAL production vulnerabilities.
      # Retry a couple times to avoid flaky registry/network failures.
      - name: pnpm audit (prod, high+) gate
        shell: bash
        run: |
          set -euo pipefail

          attempt() {
            pnpm audit --prod --audit-level=high --json > /tmp/pnpm-audit.json || true
            node scripts/pnpm-audit-gate.mjs /tmp/pnpm-audit.json
          }

          for i in 1 2 3; do
            if attempt; then
              exit 0
            fi
            echo "pnpm audit gate failed (attempt ${i}/3). Retrying..." >&2
            sleep $((i * 5))
          done

          echo "pnpm audit gate failed after retries." >&2
          exit 1

      - name: Install gitleaks CLI
        if: ${{ github.event_name != 'pull_request' }}
        shell: bash
        run: |
          set -euo pipefail

          version="8.30.0"
          archive="gitleaks_${version}_linux_x64.tar.gz"

          mkdir -p "$HOME/.local/bin"
          curl -sSfL "https://github.com/gitleaks/gitleaks/releases/download/v${version}/${archive}" -o "/tmp/${archive}"
          tar -xzf "/tmp/${archive}" -C /tmp gitleaks
          install /tmp/gitleaks "$HOME/.local/bin/gitleaks"
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
          gitleaks version

      - name: Run gitleaks (blocking)
        if: ${{ github.event_name != 'pull_request' }}
        shell: bash
        env:
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_BASE_SHA: ${{ github.event.pull_request.base.sha }}
          GITHUB_HEAD_SHA: ${{ github.event.pull_request.head.sha }}
          GITHUB_BEFORE_SHA: ${{ github.event.before }}
          GITHUB_SHA: ${{ github.sha }}
        run: |
          set -euo pipefail

          mkdir -p /tmp/gitleaks-artifacts
          log_opts="-n 1"

          if [[ "${GITHUB_EVENT_NAME}" == "pull_request" && -n "${GITHUB_BASE_SHA:-}" && -n "${GITHUB_HEAD_SHA:-}" ]]; then
            log_opts="${GITHUB_BASE_SHA}..${GITHUB_HEAD_SHA}"
          elif [[ "${GITHUB_EVENT_NAME}" == "push" && -n "${GITHUB_BEFORE_SHA:-}" && "${GITHUB_BEFORE_SHA}" != "0000000000000000000000000000000000000000" ]]; then
            log_opts="${GITHUB_BEFORE_SHA}..${GITHUB_SHA}"
          fi

          gitleaks git --redact --log-opts="${log_opts}" --report-format sarif --report-path /tmp/gitleaks-artifacts/gitleaks.sarif

      - name: Upload gitleaks report artifact
        if: ${{ always() && github.event_name != 'pull_request' }}
        uses: actions/upload-artifact@v4
        with:
          name: security-gitleaks-${{ github.run_id }}-${{ github.run_attempt }}
          path: /tmp/gitleaks-artifacts/gitleaks.sarif
          if-no-files-found: warn
