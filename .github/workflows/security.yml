name: Security

on:
  push:
    branches:
      - 'rc/**'
      - 'release/**'
  pull_request:
    branches:
      - '**'
  schedule:
    - cron: '0 6 * * 1'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  # 1. PR Check: Runs pnpm audit to catch new vulnerabilities
  pnpm-audit:
    if: ${{ github.event_name == 'pull_request' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' }}
    runs-on: blacksmith-2vcpu-ubuntu-2204
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup
        uses: ./.github/actions/setup

      - name: Security Guard (Banned Lockfile Versions)
        run: pnpm security:guard

      # Non-blocking: report all production vulnerabilities for visibility.
      # This is informational only and should not fail CI.
      - name: pnpm audit (prod) report (non-blocking)
        continue-on-error: true
        run: pnpm audit --prod

      # Blocking: fail only on HIGH/CRITICAL production vulnerabilities.
      # Retry a couple times to avoid flaky registry/network failures.
      - name: pnpm audit (prod, high+) gate
        shell: bash
        run: |
          set -euo pipefail

          attempt() {
            pnpm audit --prod --audit-level=high --json > /tmp/pnpm-audit.json || true
            node scripts/pnpm-audit-gate.mjs /tmp/pnpm-audit.json
          }

          for i in 1 2 3; do
            if attempt; then
              exit 0
            fi
            echo "pnpm audit gate failed (attempt ${i}/3). Retrying..." >&2
            sleep $((i * 5))
          done

          echo "pnpm audit gate failed after retries." >&2
          exit 1

      - name: Gitleaks license notice
        run: |
          if [ -z "${GITLEAKS_LICENSE:-}" ]; then
            echo "Gitleaks license not set. Add GitHub Secret 'GITLEAKS_LICENSE' to enable secret scanning."
          fi
        env:
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

      - name: Run gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}
