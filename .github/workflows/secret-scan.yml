name: Secret Scan

on:
  push:
    branches:
      - main
      - master
      - 'rc/**'
      - 'release/**'
  pull_request:
    branches:
      - '**'
  workflow_dispatch:

jobs:
  gitleaks:
    runs-on: blacksmith-2vcpu-ubuntu-2204
    permissions:
      contents: read
      pull-requests: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install gitleaks CLI
        shell: bash
        run: |
          set -euo pipefail

          version="8.30.0"
          archive="gitleaks_${version}_linux_x64.tar.gz"

          mkdir -p "$HOME/.local/bin"
          curl -sSfL "https://github.com/gitleaks/gitleaks/releases/download/v${version}/${archive}" -o "/tmp/${archive}"
          tar -xzf "/tmp/${archive}" -C /tmp gitleaks
          install /tmp/gitleaks "$HOME/.local/bin/gitleaks"
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
          gitleaks version

      - name: Run gitleaks (blocking)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p /tmp/gitleaks-artifacts
          gitleaks git --redact --report-format sarif --report-path /tmp/gitleaks-artifacts/gitleaks.sarif

      - name: Upload gitleaks report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: secret-scan-gitleaks-${{ github.run_id }}-${{ github.run_attempt }}
          path: /tmp/gitleaks-artifacts/gitleaks.sarif
          if-no-files-found: warn
