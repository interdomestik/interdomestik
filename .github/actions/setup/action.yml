name: 'Interdomestik Setup'
description: 'Standard environment setup for Interdomestik CI'
inputs:
  install-playwright:
    description: 'Whether to install Playwright browsers and deps'
    required: false
    default: 'false'

runs:
  using: 'composite'
  steps:
    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 10.28.2

    - name: Setup Node
      uses: actions/setup-node@v4
      with:
        node-version-file: '.nvmrc'
        cache: 'pnpm'

    - name: Ensure ripgrep
      shell: bash
      run: |
        set -euo pipefail
        if command -v rg >/dev/null 2>&1; then
          exit 0
        fi

        apt_cmd="apt-get"
        if command -v sudo >/dev/null 2>&1; then
          apt_cmd="sudo apt-get"
        fi

        ${apt_cmd} update
        ${apt_cmd} install -y ripgrep

    - name: Install dependencies
      run: pnpm install --frozen-lockfile
      shell: bash

    - name: Playwright Browser Cache
      if: inputs.install-playwright == 'true'
      uses: actions/cache@v4
      id: playwright-cache
      with:
        path: ~/.cache/ms-playwright
        key: ${{ runner.os }}-playwright-${{ hashFiles('pnpm-lock.yaml') }}
        restore-keys: |
          ${{ runner.os }}-playwright-

    - name: Install Playwright Browsers & Deps
      if: inputs.install-playwright == 'true'
      shell: bash
      run: |
        set -euo pipefail

        # Most CI paths only run Chromium projects; avoid downloading unused engines.
        if [[ "${{ steps.playwright-cache.outputs.cache-hit }}" == "true" ]]; then
          pnpm --filter @interdomestik/web exec playwright install chromium
        else
          pnpm --filter @interdomestik/web exec playwright install --with-deps chromium
        fi
