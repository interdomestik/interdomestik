# Engineering Dossier: Interdomestik V2

**Generated by Antigravity (Gemini 3.0 Advanced) on 2026-01-09**

## 0. Repo Intake Summary

- **Repo Root**: `interdomestikv2` (Monorepo via **Turborepo** + **pnpm**)
- **Frameworks**: Next.js 14+ (App Router), Drizzle ORM, Tailwind CSS, Better-Auth.
- **Key Commands** (from `package.json`):
  - `db:migrate`: `pnpm --filter @interdomestik/database migrate`
  - `seed:e2e`: `pnpm --filter @interdomestik/database seed:e2e`
  - `check`: Runs format, lint, type-check, unit tests, and build.
  - `mcp:audit`: Runs QA MCP server audits.

## 1. Project Map

### A) Repo Tree (Key Folders)

- `apps/web`: Main Next.js application.
  - `src/actions`: Server Actions (Domain-driven).
  - `src/app`: App Router (includes `api/webhooks`).
  - `src/lib`: Core utilities (`auth.core.ts`, `safe-action.ts`).
  - `e2e`: Playwright test suites.
- `packages/database`: Drizzle schema and migrations.
- `packages/domain-*`: Domain logic (Clean Architecture).
  - `domain-claims`: Claims submission and validation.
  - `domain-activities`: Activity logging.
  - `domain-membership-billing`: Subscriptions and Paddle integration.
- `packages/shared-auth`: RBAC, Session, and Permission primitives.

### B) Dependency Graph (Conceptual)

`apps/web` -> `packages/domain-*` -> `packages/database` -> `packages/shared-auth`.

- `shared-auth` is a base dependency for most packages to ensure consistent permissioning without circular deps.

### C) Key Entry Points (Top 15)

1.  `apps/web/src/lib/auth.core.ts`: **Auth Config**. Better-Auth setup, session schema extensions (tenantId, branchId).
2.  `apps/web/src/lib/safe-action.ts`: **Action Wrapper**. The security gateway for all server actions (enforces auth & context).
3.  `packages/database/src/schema/claims.ts`: **Core Schema**. The central entity (Claim) and its relations.
4.  `packages/domain-claims/src/claims/submit.ts`: **Core Business Logic**. Claim submission, attribution, and notification.
5.  `apps/web/src/actions/uploads/upload.ts`: **File Handling**. Security-hardened upload logic (magic bytes, rate limits).
6.  `apps/web/src/app/api/webhooks/paddle/route.ts`: **Payment Ingress**. Handling subscriptions and signatures.
7.  `packages/shared-auth/src/permissions.ts`: **RBAC Spec**. Permission constants and role definitions.
8.  `packages/database/src/tenant-security.ts`: **RLS Helpers**. `withTenant` and `assertTenant` utilities.
9.  `apps/web/src/proxy.ts`: **Request Context**. i18n routing + security headers.
10. `apps/web/e2e/production-smoke.spec.ts`: **Critical Test**. The "Is it down?" check.
11. `apps/web/src/actions/admin-claims/update-status.core.ts`: **Staff Workflow**. How claims move through the system.
12. `packages/database/drizzle.config.ts`: **DB Config**. Tables filter and credentials.
13. `apps/web/src/instrumentation.ts`: **Observability**. Sentry initialization.
14. `turbo.json`: **Build Pipeline**. Caching and task dependency graph.
15. `sonar-project.properties`: **Quality Gate**. Config for static analysis.

## 2. Product & Business Model

- **Personas**:
  - **Member**: Submits claims, views policy.
  - **Agent**: Sells policies, earns commission, views client claims (read-only).
  - **Branch Manager**: Manages agents and branch performance.
  - **Staff**: Processes claims (Draft -> Approved/Rejected).
  - **Tenant Admin**: Configures tenant settings.
- **Core User Journeys**:
  1.  **Claim Submission**: Member uploads evidence, submits claim -> auto-assigns to branch/agent.
  2.  **Claim Processing**: Staff reviews evidence, updates status.
  3.  **Agent Sales**: Agent refers member, earns commission on subscription.

## 3. Architecture & Boundaries (System-Level)

- **App Router**: Heavy use of **Server Actions** (`apps/web/src/actions`) over API routes (except webhooks).
- **Domain Packages**: Logic extracted to `packages/domain-*` to keep the web app thin (View Layer).
- **Data Access**: **Drizzle ORM** used directly in domains.
  - **Constraint**: Database role in `DATABASE_URL` determines connection privileges.
- **RLS Strategy**:
  - **Application-Level**: `apps/web/src/lib/safe-action.ts` calls `ensureTenantId(session)`.
  - **Query-Level**: `packages/database/src/tenant-security.ts` provides `withTenant()` helper to append `AND tenant_id = ?` to queries.
  - **Invariants**: `branchId` in `session.user` scopes Branch Managers.

## 4. Tenancy & RBAC Spec

- **Assert Session Context**:
  - Implemented in `apps/web/src/lib/safe-action.ts`.
  - Wrapper wraps `handler` and injects `session`, `tenantId`, `userRole`.
  - **Guard**: Throws `MissingTenantError` if context is lost.
- **Active Context Role**:
  - Stored in `session.user.additionalFields` (Better-Auth).
- **RBAC Truth Table** (Extracted):
  | Role | View Claim | Create Claim | Submit Claim | Transition Status | Resolve |
  | :--- | :---: | :---: | :---: | :---: | :---: |
  | Member | Own Only | Yes | Yes | No | No |
  | Agent | Linked Clients | No | No | No | No |
  | Staff | All (Tenant) | No | No | Yes | Yes |
  | Branch Mgr | Branch Only | No | No | Read-Only | No |

## 5. Data Model Summary

- **Key Tables** (`packages/database/src/schema`):
  - `tenants`: Root entity.
  - `user`: Auth entity (contains `tenantId`, `branchId`).
  - `claims`: Core transaction entity (links `userId`, `agentId`, `branchId`, `staffId`).
  - `claim_documents`: Evidence files.
  - `subscriptions`: Paddle subscription mapping.
  - `agent_commissions`: Financial records.
- **Propagation**: `tenant_id` is present on ALL major tables (User, Claim, Subscription, etc.) for strict isolation.

## 6. Critical Flows

### A) Member Claim Lifecycle (`submit.core.ts`)

1.  **Rate Limit**: Checked first (`action:submit-claim:${userId}`).
2.  **Validation**: Zod schema (`CreateClaimValues`).
3.  **Domain Call**: `submitClaimCoreDomain` (in `domain-claims`).
4.  **Attribution**:
    - Fetches `activeSubscription` to find linked Agent/Branch.
    - **Fallbacks**: Queries `tenant_settings` for `default_branch_id`.
5.  **Persistence**: Inserts to `claims` table.
6.  **Notification**: Triggers email/in-app alert.

### B) Upload Flow (`actions/uploads/upload.ts`)

1.  **Auth**: `auth.api.getSession`.
2.  **Rate Limit**: `action:upload-voice` (Limits: 5/10min).
3.  **Magic Bytes**: Uses `determineFileExtension` (reading buffer) to verify true file type, preventing extension spoofing.
4.  **Storage**: Uploads to Supabase Storage (path: `pii/tenants/${tenantId}/...`).

### C) Staff Processing (`update-status.core.ts`)

1.  **Guard**: `requireTenantAdminSession` (Should probably be `requireStaffSession` - check `roles.core.ts`).
2.  **Validation**: Zod `claimStatusSchema`.
3.  **Update**: Updates `status` and `updatedAt`.
4.  **Cache**: Revalidates admin and member paths.

### D) Webhooks (`api/webhooks/paddle/route.ts`)

1.  **Rate Limit**: 60/min.
2.  **Signature**: Verifies `paddle-signature` header against `PADDLE_WEBHOOK_SECRET_KEY`.
3.  **Handler**: Delegates to `handlePaddleWebhookCore` (idempotency checks likely inside).
4.  **Error Handling**: Captures exceptions to **Sentry** (one of the few explicit Sentry usages).

## 7. Testing & Quality Posture

- **Unit Tests**:
  - Located in `apps/web/src/**/*.test.ts` and `packages/**/*.test.ts`.
  - Run via `vitest`.
- **E2E Tests** (`apps/web/e2e`):
  - `production-smoke.spec.ts`: Critical path verification.
  - `rbac-isolation.spec.ts`: Verifies cross-tenant leakage protection.
  - `staff-flow.spec.ts`: Tests the processing queue.
- **SonarQube**:
  - Configured in `sonar-project.properties`.
  - Sources: `apps/web/src`, `packages`.
  - **Exclusions**: Properly excludes `node_modules`, `coverage`, `test`.
- **Sentry**:
  - Initialized in `instrumentation.ts`.
  - **GAP**: `apps/web/src/sentry.server.config.ts` appears **EMPTY**. This means server-side errors (Server Actions) might NOT be reporting correctly unless auto-instrumented by the Next.js SDK default (which usually requires valid config).

## 8. Observability & Error Handling

- **Explicit Sentry**: Found in `submit.core.ts` (Claim Validation) and `paddle/route.ts` (Webhooks).
- **Recommended Sentry Pattern (Snippet)**:
  ```typescript
  Sentry.captureException(error, {
    tags: { feature: 'claims', action: 'submit' },
    user: { id: session.user.id, tenant: session.user.tenantId },
  });
  ```

## 9. Production Readiness Notes

- **Issue**: `sentry.server.config.ts` is empty. **Must Fix**.
- **Issue**: Confirm `requireTenantAdminSession` in `update-status.core.ts` is not too restrictive (should Staff be able to update?).
- **Strengths**: Strong use of `safe-action` wrapper, consistent `tenant_id` pattern, Magic Bytes validation for uploads.

## 10. Discussion Pack for ChatGPT

**Tradeoffs to Discuss**:

1.  **Middleware vs. Action Wrapper**: We currently rely heavily on `safe-action` and `ensureTenantId`. Should Middleware do a "hard" reject for missing tenant context on _all_ routes?
2.  **RLS Timing**: Should we move to Postgres Row-Level Security (Native policies) immediately, or stick to application-level `withTenant` for V2 launch?
3.  **Attribution Logic**: The `submit.ts` file has a comment `// Task A: Fix Claims Attribution`. Review the implementation of `getActiveSubscription` -> `claims` insert to ensure agents get credit.

**Improvement Opportunities**:

- [High Impact/Low Effort] Fix `sentry.server.config.ts`.
- [High Impact/Medium Effort] Add explicit `agentId` validation in `submit.ts` (ensure it's not null if subscription exists).
- [Medium Impact/Low Effort] Add `upload` unit tests (mocking the `File` object and magic bytes).

---

## 11. Verification & Corrections (Active Audit)

**Date**: 2026-01-09
**Status**: Critical Gaps Identified

### A) Facts & Corrections

- **Agent Intake**: **False**. Agents _cannot_ submit claims on behalf of members. `submitClaimCore` strictly enforces `userId: session.user.id`.
- **Proxy**: âœ… **VERIFIED**. `apps/web/src/proxy.ts` is the canonical edge entrypoint (i18n + security headers).
  - _Correction_: Edge behavior is proxy-driven; business authorization remains enforced via `safe-action` wrappers.
- **Staff Status Updates**: **Broken**. `update-status.core.ts` uses `requireTenantAdminSession`, which excludes standard Staff roles.
- **Sentry**: **Gap**. `sentry.server.config.ts` is empty. Server-side exceptions are likely lost.

### B) RBAC Truth Table (Verified)

| Role       |   View Claim   | Create Claim | Submit Claim |   Transition Status   |        Resolve        |
| :--------- | :------------: | :----------: | :----------: | :-------------------: | :-------------------: |
| Member     |    Own Only    |     Yes      |     Yes      |          No           |          No           |
| Agent      | Linked Clients |      No      |      No      |          No           |          No           |
| **Staff**  |  All (Tenant)  |      No      |      No      | **NO (Fix Required)** | **NO (Fix Required)** |
| Branch Mgr |  Branch Only   |      No      |      No      |       Read-Only       |          No           |

### C) Launch Blockers

1.  **Empty Middleware**: Routing and Auth edge-cases (like redirecting unauth users) are likely broken or handled client-side only.
2.  **Staff Operational Block**: Staff cannot process claims (core function).
3.  **Observability Blindspot**: Server-side errors are not reported to Sentry.
4.  **Agent Logic**: "Submit on behalf" feature is missing (if required by business).

### D) Recommended Patches

#### 1. Fix Staff Access (`update-status.core.ts`)

```typescript
// apps/web/src/actions/admin-claims/update-status.core.ts
- import { requireTenantAdminSession } from '@interdomestik/domain-users/admin/access';
+ import { ensureTenantId, hasPermission, PERMISSIONS } from '@interdomestik/shared-auth';

export async function updateClaimStatusCore(...) {
  // ...
- await requireTenantAdminSession(session);
+ if (!session?.user) throw new Error('Unauthorized');
+ const tenantId = ensureTenantId(session);
+
+ // Allow Staff with explicit permission
+ if (!hasPermission(session.user.role, PERMISSIONS['claims.update'])) {
+    throw new Error('Permission denied');
+ }
  // ...
}
```

#### 2. Wire Sentry Server (`sentry.server.config.ts`)

```typescript
// apps/web/src/sentry.server.config.ts
import * as Sentry from '@sentry/nextjs';

Sentry.init({
  dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,
  triggers: 1.0,
  // Add environment specific config
  environment: process.env.NODE_ENV,
});
```

### E) Discussion Pack Section (Updated)

**10 Key Decisions**:

1.  **Proxy Strategy**: What edge responsibilities live in `proxy.ts` vs purely in actions/components?
2.  **Staff Permissions**: Should we create a `requireStaffSession` helper or just check `claims.update` permission?
3.  **Agent "On-Behalf"**: Is Agent submission a V2 requirement? If so, `submit.ts` needs a refactor.
4.  **Sentry Sampling**: 100% or 10%? (Cost vs. Visibility).
5.  **RLS Enforcement**: When do we enable `ALTER TABLE ... ENABLE ROW LEVEL SECURITY`?
6.  **Paddle Idempotency**: Who validates that `pnpm audit` isn't enough?
7.  **Branch Leaderboard**: Real-time or Cached?
8.  **Staging Environment**: Do we have a separate `NEXT_PUBLIC_SITE_URL` for staging?
9.  **Secrets Rotation**: Plan for `PADDLE_WEBHOOK_SECRET_KEY` rotation?
10. **Evidence Retention**: Policy for deleting old claim files?

**Top Next Tasks**:

1.  [P0] **Fix Staff Access** in `update-status.core.ts`.
2.  [P0] **Populate Middleware** (at least for i18n + Auth redirect).
3.  [P0] **Config Sentry** server-side.
4.  [P1] **Unit Test Uploads** (Security validation).
5.  [P1] **Verify Agent Attribution** (End-to-end test).
6.  [P2] **Dashboard Aggregation** (Optimize queries).
7.  [P2] **Refine Rate Limits** (Per-tenant limits?).
8.  [P3] **Translations Audit** (Missing keys).
9.  [P3] **UI Polish** (Status badges).
10. [P3] **Documentation** (Operator manual).
