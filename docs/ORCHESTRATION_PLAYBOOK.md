# Orchestration & Hardening Playbook

This playbook defines the standardized workflow for "orchestration hacking" - our methodology for enforcing architectural invariants, security defaults, and delivery contracts across the Interdomestik V2 platform.

## 1. Milestone Frozen State & Verification

When a milestone (e.g., `M3.3.1`) is completed, we must "freeze" it to prevent regression.

### Frozen State Checklist

1.  **Contract Verification**: Ensure all checks in `delivery-contract.yml` for the milestone have `status: active`.
2.  **Stress Test Validation**: Run the specific stress workload (e.g., `scripts/stress-m3.mjs`) and verify:
    - 0% Error Rate on happy path.
    - 100% Pass on Negative Security Tests (proper 403/404s).
    - p95 Latency < Threshold.
3.  **E2E Coverage**: Ensure at least one happy path and one security/failure path is covered in `apps/web/e2e/`.
4.  **Lint & Build**: Run `pnpm build` and `pnpm lint` to ensure no regression.
5.  **Tagging**: Tag the commit in git (e.g., `milestone/m3.3.1-hardened`).

## 2. Delivery Contract Workflow

We use `docs/delivery-contract.yml` to define "must-have" architectural and security rules.

### Adding a New Contract Gate

1.  **Define the Rule**: Identify a pattern that must always be true (e.g., "All API routes must use `auth.api.getSession`").
2.  **Add to YAML**:
    ```yaml
    - id: 'security.auth_check_existence'
      description: 'API Routes must verify session'
      type: 'file_content'
      targets: ['apps/web/src/app/api/**/route.ts']
      must_match: ["auth\\.api\\.getSession", 'tenantId']
      status: 'active'
    ```
3.  **Verify Compliance**: Run the auditing tool (if available) or manually grep to ensure codebase complies.
4.  **Enforce in PR**: During PR review, check `delivery-contract.yml` compliance.

## 3. PR Slicing Strategy

To maintain velocity while hardening, we slice work into:

1.  **Feature Spike**: Rapid prototyping (M3.1, M3.2). Code can be messy but functional.
2.  **Hardening Slice**: (M3.3).
    - Refactor for types/lints.
    - Add "Negative Tests" (Stress scripts).
    - Implement "Security Defaults" (Rate limits, Input validation).
3.  **Orchestration Slice**: (M3.4).
    - Update `delivery-contract.yml`.
    - Update `ORCHESTRATION_PLAYBOOK.md` if process changes.
    - Final "Green Build" verification.

## 4. Security Defaults

Every new feature must adhere to these defaults WITHOUT exception:

- **Tenant Isolation**: All DB queries MUST have `where tenantId = ?`.
- **Input Validation**: All API inputs must be validated (Zod or manual checks). Invalid inputs return `400`.
- **Auth Checks**: All protected routes must verify checks BEFORE any DB access.
- **Fail Safe**: Authentication failures return `401` or `403`. Resource missing returns `404` (never 500).
- **Secrets**: Secrets must be loaded from env. Never hardcoded.
- **Audit Logging**: Critical actions (share, delete, download) must be logged to `document_access_log`.

## 5. Unified Seeding Runner (Clean Protocol)

To eliminate flake and "User Not Found" errors, we use a single canonical seeding runner with modes.

- **Canonical Runner**: `packages/database/src/seed.ts`
- **Commands**:
  - `pnpm seed:e2e` (E2E mode): Baseline (`seedGolden`) + JS Workpack (`seedKsWorkflowPack`). Minimal, deterministic.
  - `pnpm seed:golden` (Golden mode): Baseline only. For Demos/QA.
  - `pnpm seed:full` (Full mode): Baseline + Workload. For stress/perf testing.
- **Composition**: See `src/seed.ts` for exact composition.
- **Hard Rule**: Never run individual seed scripts (like `seed-golden.ts`) directly. ALWAYS use the runner via `pnpm seed:[mode]`.
- **E2E Pipeline (Golden Path)**:
  `pnpm track:audit` -> `pnpm check` -> `pnpm db:migrate` -> `pnpm seed:e2e` -> `pnpm test:e2e -- --grep smoke` -> `pnpm test:e2e`

## 6. E2E Setup (Single Path)

E2E is intentionally contract-gated and single-path:

- **Server mode**: Playwright starts the app via `next start` (production server) for deterministic artifacts.
- **No hidden seeding**: seeding is explicit via `pnpm seed:e2e` (and can be asserted via `pnpm --filter @interdomestik/database seed:assert-e2e`).
- **Auth state**: generated by the `setup` Playwright project and reused by the rest of the suite.

Regenerate auth states:

```bash
FORCE_REGEN_STATE=1 pnpm test:e2e -- --project=setup
```

## 7. Stress Testing Methodology

For every critical API (e.g., Share Pack):

1.  **Create Script**: `scripts/stress-{feature}.mjs`.
2.  **Phases**:
    - Phase 1: Real Token Generation (Validate Happy Path).
    - Phase 2: Real Access (Validate Read Path).
    - Phase 3: Negative/Security Tests (Forgery, Expiry, Cross-Tenant).
3.  **Thresholds**: failure rate < 1%, p95 < 500ms.
4.  **Run**: `node scripts/stress-{feature}.mjs <url> <token> <tenant>`

---

_Created: Jan 2026 for Interdomestik V2 Output Hardening_
