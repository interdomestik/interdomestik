---
task_name: 'fix unit and e2e tests to reflect new proxy architecture'
task_type: 'Bug Fix'
priority: 'P1-High'
estimate: '2h'
test_level: 'full'
roadmap_ref: ''
branch: 'feat/fix-tests-proxy-arch'
start_time: 'Wed Dec 17 22:02:10 CET 2025'
baseline:
  lint: 'pass'
  typecheck: 'pass'
  tests: 'fail (exit 1)'
  format: 'fail (exit 1)'
  log: '/Users/arbenlila/development/interdomestik/.agent/tasks/logs/qa_baseline_20251217_220200.log'
---

# ğŸš€ Current Task: fix unit and e2e tests to reflect new proxy architecture

## ğŸ“‹ 10x Context Prompt

Copy the block below to your Agent to start with maximum context:

```xml
<task_definition>
  <objective>fix unit and e2e tests to reflect new proxy architecture</objective>
  <type>Bug Fix</type>
  <priority>P1-High</priority>
  <estimate>2h</estimate>
  <branch>feat/fix-tests-proxy-arch</branch>
  <constraints>
    - Use @interdomestik/ui components
    - Follow 10x-coding rules (Explore â†’ Plan â†’ Execute)
    - Mobile-first approach
    - Use next-intl for i18n
    - Write tests as specified in testing checklist
  </constraints>
</task_definition>

<reproduction_steps>
  1. Navigate to...
  2. Click on...
  3. Observe...
</reproduction_steps>
<expected_behavior>
  The expected result is...
</expected_behavior>
<actual_behavior>
  Instead, what happens is...
</actual_behavior>
```

## ğŸ—ï¸ Status Tracker

- [x] **Exploration**: Identify files using `project_map` and `read_files`
- [x] **Planning**: Create a step-by-step implementation plan
- [x] **Implementation**: Execute code changes
- [x] **Verification**: Run `pnpm qa` or relevant tests
- [ ] **Documentation**: Update relevant docs if needed

## ğŸ§ª Testing Checklist

- [ ] Unit tests added: `src/**/*.test.ts`
- [ ] Component tests added: `src/**/*.test.tsx`
- [ ] E2E tests added: `e2e/*.spec.ts`
- [ ] Tests use factories from `src/test/factories.ts`
- [ ] E2E uses fixtures from `e2e/fixtures/`
- [ ] Run: `pnpm qa` (includes all)
- [ ] All tests pass

## âœ… Definition of Done

- [ ] All acceptance criteria met
- [ ] Tests pass at required level (full)
- [ ] `pnpm lint` passes (or no new errors)
- [ ] Formatter/Prettier check passes
- [ ] `pnpm type-check` passes
- [ ] No regressions from baseline
- [ ] (Recommended) `pnpm qa:full` or full checks executed before PR
- [ ] Screenshots added for UI changes (if applicable)
- [ ] Documentation updated (if applicable)
- [ ] Code reviewed / self-reviewed

## ğŸ§  Senior Checklist

- [ ] Risks identified (perf, reliability, UX, security, data)
- [ ] Rollback/mitigation plan documented
- [ ] Monitoring/logging impact considered
- [ ] Migrations include up/down and backfill strategy (if applicable)
- [ ] Accessibility checks for UI changes
- [ ] Removed debug artifacts (console.log/debugger/TODO left behind)

## ğŸ”— Related Files

- apps/web/src/test/
- apps/web/e2e/
- apps/web/vitest.config.ts
- apps/web/playwright.config.ts

## ğŸ“‚ Active Context

- `apps/web/src/proxy.ts` - New proxy architecture replacing middleware.ts
- `apps/web/src/actions/messages.test.base.ts` - Test mocking setup file
- `apps/web/src/actions/messages.get.test.ts` - Message get tests
- `apps/web/src/actions/messages.send.test.ts` - Message send tests
- `apps/web/src/actions/messages.mark-read.test.ts` - Message mark-read tests

## ğŸ“ Implementation Notes

### Root Cause

The unit tests were failing due to a Vitest hoisting issue. The `vi.hoisted()` function creates variables that need special handling when exported.

### Fixes Applied

1. **Refactored hoisted mocks**: Changed `export const mocks = vi.hoisted(...)` to use an intermediate variable `const hoistedMocks = vi.hoisted(...); export const mocks = hoistedMocks;`
2. **Updated vi.mock factories**: Changed references from `mocks` to `hoistedMocks` inside vi.mock factory functions
3. **Fixed import order**: Ensured `./messages.test.base` is imported first before other imports

### Verification

- âœ… All 133 unit tests pass
- âœ… Smoke E2E tests pass
- âœ… Build succeeds with proxy architecture
- âœ… Lint passes

## ğŸ”¬ QA Baseline (at task start)

| Metric     | Status                                                                                         |
| ---------- | ---------------------------------------------------------------------------------------------- |
| Lint       | pass                                                                                           |
| Type Check | pass                                                                                           |
| Unit Tests | fail (exit 1)                                                                                  |
| Format     | fail (exit 1)                                                                                  |
| Log        | /Users/arbenlila/development/interdomestik/.agent/tasks/logs/qa_baseline_20251217_220200.log |

## ğŸ“ Oversized Files (>400 lines or >15000 bytes)

- apps/web/coverage/prettify.js ( 2 lines, 17590 bytes)
- packages/database/src/types.ts ( 587 lines, 16408 bytes)

---

## ğŸ“ PR Template (Copy when done)

```markdown
## What

fix unit and e2e tests to reflect new proxy architecture

## Why

## How

<!-- Implementation approach -->

## Testing

- [ ] Unit tests pass (`pnpm test:unit`)
- [ ] E2E tests pass (`pnpm test:e2e`)
- [ ] Manual QA completed
- [ ] No regressions in existing functionality

## Screenshots (if UI changes)

<!-- Add screenshots here -->

## Notes to Reviewer

<!-- Highlight areas needing careful review, known limitations, or follow-up tasks -->
```
