services:
  web:
    build:
      context: .
      dockerfile: apps/web/Dockerfile
    container_name: interdomestik-web
    ports:
      - '3000:3000'
    env_file:
      - .env
      - docker/.env
    environment:
      # Override specific vars for Docker environment
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=redis://redis:6379
      - SMTP_HOST=mailpit
      - SMTP_PORT=1025
      - S3_ENDPOINT=http://minio:9000
      - S3_PUBLIC_URL=http://localhost:9000
      - S3_REGION=us-east-1
      - S3_ACCESS_KEY=minioadmin
      - S3_SECRET_KEY=minioadmin
      - S3_BUCKET_NAME=claim-evidence
      - NEXT_PUBLIC_SUPABASE_URL=http://localhost:54321 # Pass-through or dummy if using direct S3
      - NEXT_PUBLIC_SITE_URL=http://localhost:3000
      - BETTER_AUTH_URL=http://localhost:3000
    depends_on:
      - redis
      - mailpit
      - minio
    networks:
      - interdomestik-net

  playwright:
    build:
      context: .
      dockerfile: docker/Dockerfile.test
    container_name: interdomestik-playwright
    working_dir: /app
    volumes:
      - .:/app
      # 1. Isolation: Anonymous volumes prevent host node_modules bleeding into container
      - /app/node_modules
      - /app/apps/web/node_modules
      - /app/apps/web/.next
    env_file:
      - .env
      - docker/.env
    environment:
      - CI=1
      - PLAYWRIGHT_LOCALE=sq
      - BASE_URL=http://web:3000
      - SMTP_HOST=mailpit
      - SMTP_PORT=1025
    depends_on:
      - web
    entrypoint: ['/bin/bash']
    networks:
      - interdomestik-net
    ipc: host # Recommended for browser testing

  redis:
    image: redis:alpine
    container_name: interdomestik-redis
    ports:
      - '6379:6379'
    networks:
      - interdomestik-net

  mailpit:
    image: axllent/mailpit
    container_name: interdomestik-mailpit
    ports:
      - '1025:1025' # SMTP
      - '8025:8025' # UI
    networks:
      - interdomestik-net

  minio:
    image: minio/minio
    container_name: interdomestik-minio
    command: server /data --console-address ":9001"
    ports:
      - '9000:9000' # API
      - '9001:9001' # Console
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
      # Critical for browser signed URLs to work via localhost
      - MINIO_SERVER_URL=http://localhost:9000
    volumes:
      - minio_data:/data
    networks:
      - interdomestik-net

  createbuckets:
    image: minio/mc
    container_name: interdomestik-createbuckets
    depends_on:
      - minio
    entrypoint: >
      /bin/sh -c "
      /usr/bin/mc config host add myminio http://minio:9000 minioadmin minioadmin;
      /usr/bin/mc mb -p myminio/claim-evidence;
      /usr/bin/mc anonymous set public myminio/claim-evidence;
      exit 0;
      "
    networks:
      - interdomestik-net

  # Optional Postgres for self-contained stack
  # Run with: docker compose --profile db up
  postgres:
    image: postgres:15-alpine
    container_name: interdomestik-postgres
    profiles:
      - db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
      POSTGRES_DB: interdomestik
    ports:
      - '5432:5432'
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - interdomestik-net

volumes:
  minio_data:
  postgres_data:

networks:
  interdomestik-net:
    driver: bridge
